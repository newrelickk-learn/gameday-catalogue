class SocksCounter
  include Service
  include ::NewRelic::Agent::Instrumentation::ControllerInstrumentation

  def initialize(tags)
    @tags = tags
  end

  def call
    
    ::NewRelic::Agent.add_custom_attributes({
      'socks_counter.tags_count' => @tags.length,
      'socks_counter.has_tags' => @tags.length > 0
    })

    @socks = [];
    if @tags.length > 0
      @socks = Sock.joins(sock_tags: :tag).where(tag: { name: @tags.map { |tag| tag.strip! ? tag.strip! : tag }}).distinct
    else
      @socks = Sock.all
    end
    
    result_size = @socks.size
    
    ::NewRelic::Agent.add_custom_attributes({
      'socks_counter.result_size' => result_size
    })

    return { size: result_size }
  end
  
  # メソッドをトレース対象として追加
  add_transaction_tracer :call, name: 'SocksCounter#call'

end